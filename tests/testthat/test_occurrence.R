library(obisclient)
context("occurrence")

small_test_species <- "Abra sibogai"
small_test_aphiaid <- 345684
other_test_aphiaid <- 141438 # Abra segmentum

test_that("occurrence returns small number of records for a scientific name", {
  records <- occurrence(scientificname = small_test_species, verbose = TRUE)
  expect_more_than(nrow(records), 0)
  expect_true(is.data.frame(records))
  expect_true(all(records$scientificName == small_test_species))
  expect_true(all(records$aphiaID == small_test_aphiaid))
})

test_that("occurrence returns small number of records for an aphia id", {
  records <- occurrence(aphiaid = small_test_aphiaid)
  expect_more_than(nrow(records), 0)
  expect_true(is.data.frame(records))
  expect_true(all(records$aphiaID == small_test_aphiaid))
})

test_that("occurrence returns small number of records for an obis id", {
  records <- occurrence(aphiaid = small_test_aphiaid) ## obis ids are not stable so taking a detour
  records <- occurrence(obisid = records$obisID[1])
  expect_more_than(nrow(records), 0)
  expect_true(is.data.frame(records))
  expect_true(all(records$taxonID == records$obisID[1]))
  expect_true(all(records$aphiaID == small_test_aphiaid))
})

test_that("occurrence returns records filtered on year",{
  records_original <- occurrence(aphiaid = other_test_aphiaid)
  year <- na.omit(records_original$yearcollected)[1]
  records <- occurrence(aphiaid = other_test_aphiaid, year = year)
  expect_more_than(year, 0)
  expect_more_than(nrow(records), 0)
  expect_less_than(nrow(records), nrow(records_original))
  expect_true(all(records$yearcollected == year))
})

expect_filtered <- function(...) {
  records <- occurrence(aphiaid = other_test_aphiaid, ...)
  expect_more_than(NROW(records), 0)
  expect_less_than(NROW(records), nrow(occurrence(aphiaid = other_test_aphiaid)))
  records
}

test_that("occurrence returns records filtered on startdate",{
  start <- as.Date("2007-06-22")
  records <- expect_filtered(startdate = start)
  expect_true(all(as.Date(records$eventDate) > start))
})

test_that("occurrence returns records filtered on enddate",{
  end <- as.Date("2007-06-22")
  records <- expect_filtered(enddate = end)
  expect_true(all(as.Date(records$eventDate) < end))
})

test_that("occurrence returns records filtered on start and enddate",{
  start <- as.Date("2007-06-22")
  end <- as.Date("2011-1-1")
  records <- expect_filtered(startdate = start, enddate = end)
  expect_true(all(as.Date(records$eventDate) > start))
  expect_true(all(as.Date(records$eventDate) < end))
})

test_that("occurrence returns 0 records then no errors occur",{
  records <- occurrence(aphiaid = other_test_aphiaid, startdate = as.Date("3210-1-1"))
  expect_equal(NROW(records), 0)
})

test_that("occurrence returns records filtered on geometry",{
  records <- expect_filtered(geometry = "POLYGON ((0 0, 0 45, 45 45, 45 0, 0 0))")
  expect_true(all(records$decimalLongitude < 45))
  expect_true(all(records$decimalLatitude < 45))
  expect_true(all(records$decimalLongitude > 0))
  expect_true(all(records$decimalLatitude > 0))
})

test_that("qc flags in queries are respected", {
  records <- occurrence(scientificname = small_test_species)

  check_qc_no_zero <- function(records) {
    qc_ok <- sapply(1:30, function(qc) { c(row=bitwAnd(records$qc, 2^(qc-1)) > 0) })
    which(colSums(qc_ok) < nrow(qc_ok) & colSums(qc_ok) != 0)
  }
  qc_numbers_not_ok <- check_qc_no_zero(records)
  records_with_qc <- occurrence(scientificname = "Abra sibogai", qc=qc_numbers_not_ok)
  expect_equal(length(check_qc_no_zero(records_with_qc)), 0)
  expect_less_than(nrow(records_with_qc), nrow(records))
})

test_that("occurrence returns requested fields",{
  fields = c("species", "decimalLongitude", "decimalLatitude")
  records <- occurrence(aphiaid = small_test_aphiaid, fields = fields)
  expect_more_than(nrow(records), 0)
  expect_equal(colnames(records), fields)
})

test_that("occurrence test warnings",{
  expect_warning({occurrence(aphiaid = -1)})
  expect_warning({occurrence(aphiaid = small_test_aphiaid, year = NA)})
  expect_warning({occurrence(aphiaid = small_test_aphiaid, year = "test")})
  expect_warning({occurrence(aphiaid = small_test_aphiaid, fields = c("species", "abcdefghij"))})
  expect_warning({occurrence(geometry="POLYGON ((41.5737322000000020 -1.6594444399999999, 45.8918815400000000 -1.6594444399999999, 45.9112305599999999 -1.6594444399999999, 45.8996515400000007 -1.6675606500000000, 45.8939805400000012 -1.6732376499999999, 45.8939415400000001 -1.6732646499999999, 45.8918815400000000 -1.6753276500000001, 45.8836715400000017 -1.6810816500000001, 45.8831795400000004 -1.6815746499999999, 45.8830535399999988 -1.6816626500000000, 45.8818785400000024 -1.6828396500000000, 45.8735645399999967 -1.6886676500000000, 45.8706765399999981 -1.6915576500000000, 45.8706015400000027 -1.6916116500000000, 45.8693755400000001 -1.6928376500000000, 45.8552675399999998 -1.7027266500000000, 45.8551765400000022 -1.7028186500000000, 45.8441985400000007 -1.7105146499999999, 45.8435745399999988 -1.7111386500000001, 45.8379695400000031 -1.7150676499999999, 45.8327735399999980 -1.7202706500000000, 45.8297395399999985 -1.7223966500000001, 45.8268705400000016 -1.7252686500000001, 45.8242175399999994 -1.7271286500000000, 45.8218725400000011 -1.7294766500000001, 45.8188115399999987 -1.7316216499999999, 45.8178155399999980 -1.7326196500000000, 45.8159295399999991 -1.7353156500000000, 45.8034405399999969 -1.7478206500000000, 45.8017255399999996 -1.7502716500000000, 45.8003535400000032 -1.7516456499999999, 45.7984245399999992 -1.7544036500000000, 45.7946375399999965 -1.7581956500000000, 45.7946235400000035 -1.7582156499999999, 45.7928395400000028 -1.7600016500000000, 45.7909215399999994 -1.7627446499999999, 45.7792785400000000 -1.7744016499999999, 45.7775145399999985 -1.7769226499999999, 45.7730405399999967 -1.7814026500000000, 45.7692095399999985 -1.7868806500000001, 45.7668605400000033 -1.7892326500000000, 45.7650075399999992 -1.7918816500000001, 45.7621965399999979 -1.7946956500000000, 45.7621075400000024 -1.7948246500000000, 45.7567075400000007 -1.8002306500000000, 45.7567035399999966 -1.8002366500000000, 45.7503925400000000 -1.8065546500000000, 45.7484025400000007 -1.8093996500000000, 45.7466865399999989 -1.8111186500000001, 45.7449985399999974 -1.8135326500000000, 45.7437685399999978 -1.8147636500000000, 45.7416965399999995 -1.8177256500000001, 45.7404665399999999 -1.8189576500000000, 45.7383955399999991 -1.8219196499999999, 45.7268835400000029 -1.8334456500000000, 45.7250915400000011 -1.8360076500000000, 45.7227425399999987 -1.8383596499999999, 45.7208895400000017 -1.8410096499999999, 45.7133935399999984 -1.8485136499999999, 45.7133865400000019 -1.8485246500000001, 45.7110375399999995 -1.8508766500000000, 45.7091845400000025 -1.8535266500000001, 45.7077165399999998 -1.8549966499999999, 45.7075815399999996 -1.8551886500000001, 45.6991945400000006 -1.8635856500000001, 45.6974755399999992 -1.8660436499999999, 45.6953985399999993 -1.8681246499999999, 45.6933765400000027 -1.8710146500000000, 45.6923435400000031 -1.8720496499999999, 45.6907735400000021 -1.8742936500000000, 45.6815885399999999 -1.8834906499999999, 45.6812715399999973 -1.8839446500000001, 45.6666395399999985 -1.8985946499999999, 45.6649645399999997 -1.9009896500000001, 45.6635195400000029 -1.9024366500000001, 45.6616625400000018 -1.9050916499999999, 45.6600905399999988 -1.9066656500000001, 45.6582585399999985 -1.9092866500000001, 45.6544505399999991 -1.9130986500000000, 45.6524565400000029 -1.9159496499999999, 45.6361325399999984 -1.9322946500000000, 45.6341495400000028 -1.9351296499999999, 45.6335875400000006 -1.9356936499999999, 45.6316455400000009 -1.9384696500000000, 45.6204815400000001 -1.9496486500000001, 45.6204415400000016 -1.9497056500000001, 45.6170605399999971 -1.9530906500000000, 45.6133385400000009 -1.9584136500000000, 45.6010605399999989 -1.9707066499999999, 45.5991335399999969 -1.9734626500000001, 45.5933475400000034 -1.9792566500000000, 45.5916305399999970 -1.9817116500000000, 45.5911755400000018 -1.9821676500000001, 45.5891265400000023 -1.9850976499999999, 45.5749045399999986 -1.9993376500000000, 45.5732195399999966 -2.0017466499999998, 45.5664335399999985 -2.0085416500000002, 45.5662165399999992 -2.0088516500000000, 45.5590775399999970 -2.0160006500000001, 45.5574125400000014 -2.0183816499999998, 45.5513065399999988 -2.0244956500000000, 45.5512105399999996 -2.0246326500000000, 45.5316235399999982 -2.0442456500000001, 45.5299005399999999 -2.0467096499999999, 45.5296835400000006 -2.0469276500000002, 45.5274985400000034 -2.0500506500000002, 45.5218905400000011 -2.0556656499999999, 45.5199955399999965 -2.0583756499999999, 45.5152615399999974 -2.0631166500000000, 45.5115915399999977 -2.0683646499999999, 45.5087085400000007 -2.0712516500000002, 45.5086905400000035 -2.0712776499999999, 45.5026705399999969 -2.0773056500000000, 45.5007865400000000 -2.0799996500000000, 45.4966355399999998 -2.0841556500000000, 45.4948825399999990 -2.0866636500000002, 45.4938015399999998 -2.0877456500000000, 45.4936835399999993 -2.0879136500000000, 45.4891565400000033 -2.0924466499999999, 45.4873785400000017 -2.0949886499999999, 45.4852845400000021 -2.0970856499999999, 45.4852795400000005 -2.0970926500000000, 45.4767995400000018 -2.1055846499999999, 45.4707725399999987 -2.1142036499999999, 45.4383235399999990 -2.1466966500000000, 45.4365545400000030 -2.1492266500000001, 45.2536965400000000 -2.3323356500000001, 45.0654295399999967 -2.6015446500000001, 45.0631835399999972 -2.6037926499999999, 45.0630285399999977 -2.6040146499999999, 45.0210735400000033 -2.6460286499999999, 45.0020915400000021 -2.6731696500000002, 45.0009045400000005 -2.6743576500000001, 45.0008925400000024 -2.6743746499999999, 44.9992155400000016 -2.6760536500000001, 44.9971895400000008 -2.6789506500000000, 44.9268345400000015 -2.7494026499999999, 44.8712095400000024 -2.8289306500000002, 44.8693405400000032 -2.8308026499999999, 44.8692095399999999 -2.8309896499999998, 44.8675225400000031 -2.8326786500000001, 44.8620025399999989 -2.8405716499999998, 44.8591195400000018 -2.8434576499999999, 44.8591015399999975 -2.8434836500000000, 44.8558695400000005 -2.8467206500000000, 44.8519975399999993 -2.8522556500000000, 44.8467245399999968 -2.8575366500000001, 44.8445925400000007 -2.8605846499999998, 44.8379415400000028 -2.8672446500000000, 44.8361875399999974 -2.8697516500000000, 44.8280565399999986 -2.8778936499999999, 44.8069655400000002 -2.9080466500000002, 44.8059565399999968 -2.9090566500000001, 44.8057665400000005 -2.9093286500000000, 44.7944155400000028 -2.9206936500000000, 44.7886545400000031 -2.9289306499999999, 44.7874465399999977 -2.9301396500000001, 44.7836495399999990 -2.9355676499999999, 44.7833085400000002 -2.9359096500000001, 44.7832495399999999 -2.9359946500000000, 44.7786685399999982 -2.9405806499999998, 44.7769475400000019 -2.9430416500000001, 44.7740645399999977 -2.9459276499999998, 44.7740465400000005 -2.9459546500000000, 44.7717265400000031 -2.9482776500000001, 44.7695415399999987 -2.9514006500000001, 44.7582675399999985 -2.9626896500000002, 44.7545335399999971 -2.9680276499999998, 44.7442405399999998 -2.9783336500000002, 44.7386235399999990 -2.9863636499999999, 44.7205945400000004 -3.0044156499999999, 44.7070015400000003 -3.0238476500000000, 44.6959735399999971 -3.0348896500000002, 44.6943945399999976 -3.0371476500000001, 44.6936005399999985 -3.0379416500000000, 44.6931955399999978 -3.0385206500000002, 44.6929465400000012 -3.0387706500000000, 44.6660705399999998 -3.0771886500000001, 44.6650275399999970 -3.0782336500000000, 44.6648715400000000 -3.0784546499999998, 44.6585975400000024 -3.0847366500000000, 44.6568675400000004 -3.0872106499999998, 44.6532705400000012 -3.0908116500000000, 44.6531655400000034 -3.0909626499999998, 44.6436385399999978 -3.1005006499999999, 44.6360525400000014 -3.1113446499999999, 44.6335845400000011 -3.1138156499999998, 44.6335525399999966 -3.1138616500000000, 44.5982655399999999 -3.1491916500000001, 44.5793165400000007 -3.1762756500000000, 44.5790065400000017 -3.1765866500000000, 44.5789165400000016 -3.1767156499999998, 44.5775615399999978 -3.1780716500000001, 44.5718075400000018 -3.1862956499999999, 44.5714165400000013 -3.1866876500000001, 44.5714105400000022 -3.1866956499999999, 44.5637285399999996 -3.1943866500000002, 44.5559995400000020 -3.2054336499999998, 44.5539285400000011 -3.2075076500000002, 44.5538965399999967 -3.2075526499999998, 44.5280505400000024 -3.2334286500000000, 44.5192115400000006 -3.2523896500000000, 44.5187355400000015 -3.2530706500000002, 44.5183105400000017 -3.2539806499999999, 44.2780135400000034 -3.6062326499999999, 43.1914955399999982 -2.8415046500000001, 42.1066905400000024 -2.0758686499999999, 42.0756595399999966 -2.0548336500000000, 41.9409625400000010 -1.9636116500000000, 41.6096555399999986 -1.7155386500000001, 41.6087045399999980 -1.7147666500000001, 41.5915745400000034 -1.7012646499999999, 41.5853495400000028 -1.6962646500000000, 41.5793755400000009 -1.6942216500000000, 41.5601335400000025 -1.6729786499999999, 41.5716635400000030 -1.6619456500000001, 41.5737322000000020 -1.6594444399999999))")})
})
